<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Katarina & Ivan üíç</title>
  <meta name="apple-mobile-web-app-title" content="Katarina & Ivan">
  <meta name="application-name" content="Katarina & Ivan">
  <meta property="og:title" content="Katarina & Ivan">
  <meta property="og:site_name" content="Katarina & Ivan">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://stjepanbm.github.io/Ivan_Kate_Wedding_App/">
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Playfair Display', serif; }
    @keyframes fadeInUp { from {opacity:0;transform:translateY(20px);} to {opacity:1;transform:translateY(0);} }
    .fade-in-up { opacity:0; animation: fadeInUp 1.6s ease forwards; }
    .btn-rose {
      background-color:#b76e79;border:1px solid #a65e6a;color:#fff;border-radius:9999px;
      box-shadow:0 4px 8px rgba(183,110,121,0.3);transition:all 0.3s ease;
    }
    .btn-rose:hover { background-color:#a65e6a; box-shadow:0 6px 12px rgba(166,94,106,0.35); transform:translateY(-2px); }
    .button-group { margin-top:10rem; display:flex; justify-content:center; gap:1rem; }

    /* Heart pop animation */
    @keyframes heartPop {
      0% { transform: scale(1); }
      25% { transform: scale(1.4); }
      50% { transform: scale(1.1); }
      75% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    /* ISPRAVKA 1: Klasa 'pop' je sada usklaƒëena sa JS-om za animaciju */
    .pop { animation: heartPop 0.4s ease-in-out; } 

    /* Fix: make like button transformable and nicely aligned */
    .like-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      transform-origin: center;
      user-select: none;
    }
    /* Ensure the counter doesn't scale as much as the heart emoji */
    .like-btn span {
      font-weight: 600;
      transform-origin: center;
      display: inline-block;
    }
  </style>
</head>

<body class="bg-green-100 text-green-900">

  <div class="fixed inset-0 z-0">
    <div class="absolute inset-0 bg-cover bg-center" style="background-image:url('images/Kate_Ivan_Main.jpeg');"></div>
    <div class="absolute inset-0 bg-emerald-900 opacity-60"></div>
  </div>

  <div class="relative z-10 min-h-screen bg-opacity-95">
    <header class="flex flex-col items-center justify-center text-center py-32">
      <h1 class="text-5xl md:text-6xl font-bold mb-4 text-stone-200 fade-in-up">Katarina & Ivan</h1>
      <p class="text-sm tracking-widest uppercase text-stone-300 mb-8 fade-in-up">11/10/2025</p>
      <div class="button-group fade-in-up">
        <button id="uploadBtn" class="btn-rose px-6 py-2 font-medium">üì∏ Dodaj Slike</button>
        <button id="noteBtn" class="btn-rose px-6 py-2 font-medium">üíå Ostavite trag ljubavi</button>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 mb-20">
      <div id="gallery" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <img src="images/IMG_3501.jpeg" class="gallery-img w-full h-96 object-cover rounded-2xl shadow-lg hover:scale-105 transition-transform duration-300 cursor-pointer" alt="">
        <img src="images/IMG_3570.jpeg" class="gallery-img w-full h-96 object-cover rounded-2xl shadow-lg hover:scale-105 transition-transform duration-300 cursor-pointer" alt="">
        <img src="images/IMG_3115.jpeg" class="gallery-img w-full h-96 object-cover rounded-2xl shadow-lg hover:scale-105 transition-transform duration-300 cursor-pointer" alt="">
        <img src="images/IMG_3134.jpeg" class="gallery-img w-full h-96 object-cover rounded-2xl shadow-lg hover:scale-105 transition-transform duration-300 cursor-pointer" alt="">
        <img src="images/IMG_3102.jpeg" class="gallery-img w-full h-96 object-cover rounded-2xl shadow-lg hover:scale-105 transition-transform duration-300 cursor-pointer" alt="">
        <img src="images/IMG_3086.jpg" class="gallery-img w-full h-96 object-cover rounded-2xl shadow-lg hover:scale-105 transition-transform duration-300 cursor-pointer" alt="">
      </div>

      <section id="notesSection" class="mt-16">
        <h2 class="text-3xl font-semibold text-center text-stone-200 mb-6">Poruke</h2>
        <div id="notes" class="grid gap-4 max-w-3xl mx-auto"></div>
      </section>
    </main>

    <div id="noteModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl shadow-lg w-11/12 max-w-md p-6 relative fade-in-up">
        <button id="closeModal" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">‚úï</button>
        <h3 class="text-2xl font-semibold text-gray-700 mb-4 text-center">Ostavite trag ljubavi üíå</h3>
        <input id="guestName" type="text" maxlength="40" placeholder="Va≈°e ime (opcionalno)" class="w-full mb-3 border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-gray-500 focus:outline-none" />
        <textarea id="noteInput" rows="4" maxlength="300" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-gray-500" placeholder="Napi≈°ite svoju poruku... (max 300 znakova)"></textarea>
        <button id="submitNote" class="mt-4 w-full btn-rose py-2">Po≈°alji üíå</button>
      </div>
    </div>

    <div id="lightbox" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
      <button id="closeLightbox" class="absolute top-5 right-6 text-white text-3xl hover:text-gray-300">‚úï</button>
      <button id="prevBtn" class="absolute left-5 text-white text-5xl hover:text-gray-400 px-2">‚Äπ</button>
      <button id="nextBtn" class="absolute right-5 text-white text-5xl hover:text-gray-400 px-2">‚Ä∫</button>
      <img id="lightboxImage" src="" class="max-w-[90%] max-h-[90%] rounded-xl shadow-2xl border border-white" alt="Full-size photo">
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, increment, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCnFHaeaqrVyr1p_g3Z5uKLar8vY6Wjxgo",
      authDomain: "kateivan.firebaseapp.com",
      projectId: "kateivan",
      storageBucket: "kateivan.firebasestorage.app",
      messagingSenderId: "1021583777843",
      appId: "1:1021583777843:web:fb98f04ed71c907e73c346"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const uploadBtn = document.getElementById('uploadBtn');
    const noteBtn = document.getElementById('noteBtn');
    const noteModal = document.getElementById('noteModal');
    const closeModal = document.getElementById('closeModal');
    const submitNote = document.getElementById('submitNote');
    const noteInput = document.getElementById('noteInput');
    const guestName = document.getElementById('guestName');
    const notesContainer = document.getElementById('notes');
    const GOOGLE_DRIVE_LINK = 'https://www.dropbox.com/request/fDsFF9LX0nL083u2Pnz9';

    const galleryImages = document.querySelectorAll('.gallery-img');
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightboxImage');
    const closeLightbox = document.getElementById('closeLightbox');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    uploadBtn.addEventListener('click', () => window.open(GOOGLE_DRIVE_LINK, '_blank'));
    noteBtn.addEventListener('click', () => {
      noteModal.classList.remove('hidden');
      document.getElementById("notesSection").scrollIntoView({ behavior: "smooth" });
    });
    closeModal.addEventListener('click', () => noteModal.classList.add('hidden'));
    noteModal.addEventListener('click', e => { if (e.target === noteModal) noteModal.classList.add('hidden'); });

    // üîí Limit ukupnih poruka
    const notesLimit = 1000;

    // ----------------------------------------------------
    // üí° NOVO: Funkcije za upravljanje Local Storage-om (za 1 like po korisniku)
    // ----------------------------------------------------

    // Dohvaƒáa lajkane ID-ove iz Local Storage-a
    const getLikedNotes = () => {
        const liked = localStorage.getItem('likedNotes');
        try {
            return liked ? JSON.parse(liked) : [];
        } catch (e) {
            console.error("Gre≈°ka pri parsiranju Local Storage:", e);
            return [];
        }
    };

    // Sprema lajkani ID u Local Storage
    const saveLikedNote = (noteId) => {
        const liked = getLikedNotes();
        if (!liked.includes(noteId)) {
            liked.push(noteId);
            localStorage.setItem('likedNotes', JSON.stringify(liked));
        }
    };

    // Provjerava je li poruka lajkana
    const isNoteLiked = (noteId) => {
        return getLikedNotes().includes(noteId);
    };


    // Submit note s limitom
    submitNote.addEventListener('click', async () => {
      const text = noteInput.value.trim();
      const name = guestName.value.trim() || "Anonimno";
      if (!text) return alert("Unesite poruku üíå");

      try {
        // Provjeri broj poruka prije dodavanja
        const snapshot = await getDocs(collection(db, "notes"));
        if (snapshot.size >= notesLimit) {
          return alert("Dostignut je maksimalan broj poruka üíî");
        }

        await addDoc(collection(db, "notes"), {
          name, text, likes: 0, timestamp: serverTimestamp()
        });

        noteInput.value = ''; 
        guestName.value = '';
        noteModal.classList.add('hidden');
      } catch (err) {
        console.error("Gre≈°ka:", err);
      }
    });


    // Lightbox logic
    let currentIndex = 0;
    const images = Array.from(galleryImages);
    function openLightbox(index) { currentIndex = index; lightboxImage.src = images[currentIndex].src; lightbox.classList.remove('hidden'); }
    function showNext() { currentIndex = (currentIndex + 1) % images.length; lightboxImage.src = images[currentIndex].src; }
    function showPrev() { currentIndex = (currentIndex - 1 + images.length) % images.length; lightboxImage.src = images[currentIndex].src; }
    images.forEach((img, index) => img.addEventListener('click', () => openLightbox(index)));
    closeLightbox.addEventListener('click', () => lightbox.classList.add('hidden'));
    lightbox.addEventListener('click', e => { if (e.target === lightbox) lightbox.classList.add('hidden'); });
    nextBtn.addEventListener('click', showNext);
    prevBtn.addEventListener('click', showPrev);
    window.addEventListener('keydown', e => {
      if (lightbox.classList.contains('hidden')) return;
      if (e.key === 'ArrowRight') showNext();
      if (e.key === 'ArrowLeft') showPrev();
      if (e.key === 'Escape') lightbox.classList.add('hidden');
    });

    // Scroll fade-in with stagger
    const reveals = document.querySelectorAll('.reveal');
    const observer = new IntersectionObserver(entries => {
      entries.forEach((entry, index) => {
        if (entry.isIntersecting) {
          setTimeout(() => {
            entry.target.classList.add('visible');
          }, index * 120); // stagger timing (120ms per image)
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1 });

    reveals.forEach(el => observer.observe(el));

    // Uƒçitavanje bilje≈°ki i like button
    const q = query(collection(db, "notes"), orderBy("timestamp", "desc"));
    onSnapshot(q, snapshot => {
        const likedNotesIds = getLikedNotes(); // Dohvati jednom sve lajkane ID-ove
        
       snapshot.docChanges().forEach(change => {
          const noteId = change.doc.id;
          const note = change.doc.data();
          let noteDiv = document.querySelector(`[data-id="${noteId}"]`);

          const liked = likedNotesIds.includes(noteId); // Provjera je li poruka veƒá lajkana
          
          if (change.type === "added" && !noteDiv) {
            noteDiv = document.createElement('div');
            noteDiv.dataset.id = noteId;
            noteDiv.className = 'p-4 bg-white rounded-lg shadow text-gray-700 text-left';
            
            // Postavljanje stila gumba ovisno o Local Storage-u
            const btnClass = liked 
                ? 'like-btn mt-2 text-gray-400 cursor-default' // Onemoguƒáeno ako je veƒá lajkano
                : 'like-btn mt-2 text-pink-500 hover:text-pink-600 transition';
            
            noteDiv.innerHTML = `
              <p class="text-lg">${note.text}</p>
              <p class="text-sm text-gray-500 mt-1">${note.name}</p>
              <button class="${btnClass}" ${liked ? 'disabled' : ''}>
                <span class="heart">‚ù§Ô∏è</span> <span class="count">${note.likes || 0}</span>
              </button>
            `;
            notesContainer.prepend(noteDiv);

            // Dodaj event listener
            const btn = noteDiv.querySelector('.like-btn');
            
            // Listener se dodaje samo ako gumb nije disabled (tj. ako nije lajkan)
            if (!liked) {
                btn.addEventListener('click', async () => {
                  
                  // Dodatna provjera za svaki sluƒçaj
                  if (isNoteLiked(noteId)) return;

                  const heart = btn.querySelector('.heart');
                  const count = btn.querySelector('.count');
                  
                  // Lokalni optimistiƒçni UI update
                  count.textContent = parseInt(count.textContent) + 1; 
                  
                  // ISPRAVKA 2: Kori≈°tenje ispravne klase 'pop' za animaciju
                  heart.classList.add('pop'); 
                  setTimeout(() => heart.classList.remove('pop'), 400);
                  
                  // üí° OGRANIƒåENJE LAJKA: Spremi u Local Storage i onemoguƒái gumb
                  saveLikedNote(noteId); 
                  btn.disabled = true;
                  btn.classList.remove('text-pink-500', 'hover:text-pink-600', 'transition');
                  btn.classList.add('text-gray-400', 'cursor-default');

                  const noteRef = doc(db, "notes", noteId);
                  await updateDoc(noteRef, { likes: increment(1) });
                });
            }
          } 
          else if (change.type === "modified" && noteDiv) {
            // A≈æuriranje broja lajkova kada Firebase javi promjenu
            const count = noteDiv.querySelector('.count');
            count.textContent = note.likes || 0;
            
            // Osiguraj da gumb ostane disabled/siv ako je lajkan
            const btn = noteDiv.querySelector('.like-btn');
            if (isNoteLiked(noteId) && btn && !btn.disabled) {
                 btn.disabled = true;
                 btn.classList.remove('text-pink-500', 'hover:text-pink-600', 'transition');
                 btn.classList.add('text-gray-400', 'cursor-default');
            }
          }
       }); 
    });
  </script>
</body>
</html>